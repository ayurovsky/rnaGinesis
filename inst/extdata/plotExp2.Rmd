---
title: "plotExp2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

### Makes plots to evaluate deconvolution methods on Experiment 2 mixture from scRNA-seq data

#### Obtain trueH, trueW and resultH, resultW from each deconvolution method
```{r}
# Obtains trueW, trueH from exp2.RData
load("~/rnaGinesis/data/exp2.RData")
trueW <- experiment2$trueW
trueH <- experiment2$trueH

# Obtains resultW, resultH from NMF and rearranges them to match trueW, trueH ordering
load("~/rnaGinesis/data/exp2.NMF.result.RData")
plot(exp2.NMF$resultH[1,],trueH[1,])
print(names(exp2.NMF))
exp2.NMF <- rearrange(exp2.NMF, experiment2)
print(names(exp2.NMF))
plot(exp2.NMF$resultH[1,],trueH[1,])
plot(exp2.NMF$resultH[2,],trueH[2,])
plot(exp2.NMF$resultH[3,],trueH[3,])
```

```{r}
resultW.NMF <- exp2.NMF[[1]]
resultH.NMF <- exp2.NMF[[2]]

# Obtains resultW, resultH from DeMixT and rearranges them to match trueW, trueH ordering
#load("~/rnaGinesis/rnaGinesis/data/exp2.DeMixT.result.RData")
# exp2.DeMixT <- rearrange(exp2.DeMixT, experiment2)
# resultW.DeMixT <- exp2.DeMixT[[1]]
# resultH.DeMixT <- exp2.DeMixT[[2]]

# Obtains resultW, resultH from CIBERSORT and rearranges them to match trueW, trueH ordering
load("~/rnaGinesis/data/exp2.CIBERSORT.result.RData")
exp2.CIBERSORT <- rearrange(exp2.CIBERSORT, experiment2)
plot(exp2.CIBERSORT$resultH[1,],trueH[1,])
plot(exp2.CIBERSORT$resultH[1,],trueH[2,])
plot(exp2.CIBERSORT$resultH[1,],trueH[3,])

resultW.CIBERSORT <- exp2.CIBERSORT[[1]]
resultH.CIBERSORT <- exp2.CIBERSORT[[2]]
```

#### Creates H.RMSE with RMSE between true props and estimated props across all samples for each deconvolution method
```{r}
# Normalizes resultH so that proportions sum to 1
resultH.NMF <- apply(resultH.NMF, 2, FUN = sum_to_1)
resultH.CIBERSORT <- apply(resultH.CIBERSORT, 2, FUN = sum_to_1)

# Obtains RMSE for each sample between true proportions and estimated proportions
H.RMSE <- makeH.RMSE(trueH, resultH.NMF, resultH.CIBERSORT)
```

#### Graphs violin plot with H.RMSE values from each deconvolution method
```{r}
# melts H.RMSE into dataframe with two variables, method (1 = CIBERSORT, 2 = NMF) and H.RMSE across all samples for each deconvolution method 
mydf <- reshape2::melt(H.RMSE)
mydf <- mydf[,-1]
names(mydf) <- c("method", "H_RMSE") 

# plots H.RMSE between true proportions and estimated proportions in each sample based on deconvolution method
p <- ggplot2::ggplot(data = mydf, ggplot2::aes(y = H_RMSE, x= method, fill = method))
p <- p + ggplot2::geom_violin()
p <- p + ggplot2::geom_jitter(width = 0.1, height = 0) + ggplot2::ylim(0,1) 
p <- p + ggplot2::labs(title="Violin Plots of Root Mean Squared Error (RMSE) for Proportions",
                       x = "Deconvolution Method",
                       y = "H_RMSE")
p <- p + ggplot2::theme(axis.title.x = ggplot2::element_text(size = 40)) 
p <- p +  ggplot2::theme(axis.title.y = ggplot2::element_text(size = 40)) 
p <- p +  ggplot2::theme(axis.text = ggplot2::element_text(size=30))

print(p)
```

#### Creates W.COSDIST with COSDIST between true cell-type specific gene expression profiles and estimated gene expression profiles for each sample
```{r}
#W.RMSE <- makeW.RMSE(trueW, resultW.NMF, resultW.CIBERSORT)

W.COSDIST <- makeW_COSDIST(trueW, resultW.NMF, resultW.CIBERSORT)
#W.COSDIST <- makeW_COSDIST(trueW, resultW)
```

#### Graphs violin plots with W.COSDIST values from each deconvolution method
```{r}
# melts W.COSDIST into dataframe with two variables, method (1 = CIBERSORT, 2 = NMF) and W.COSDIST across all samples for each deconvolution method 
mydf2 <- reshape2::melt(W.COSDIST)
mydf2 <- mydf2[,-1]

names(mydf2) <- c("method", "W_COSDIST") 

# plots W.COSDIST between true W and estimated W in each sample based on deconvolution method
p2 <- ggplot2::ggplot(data = mydf2, ggplot2::aes(y = W_COSDIST, x= method, fill = method))
p2 <- p2 + ggplot2::geom_violin()
p2 <- p2 + ggplot2::geom_jitter(width = 0.1, height = 0) + ggplot2::ylim(0,1.5) 
p2 <- p2 + ggplot2::labs(title="Violin Plots of Cosine Distance (COSDIST) for Gene Expression",x = "Deconvolution Method", y = "W_COSDIST") + ggplot2::theme(axis.title.x = ggplot2::element_text(size = 40)) + ggplot2::theme(axis.title.y = ggplot2::element_text(size = 40)) + ggplot2::theme(axis.text=ggplot2::element_text(size=30))
print(p2)
```