---
title: "run2.CIBERSORT"
output: html_document
---


## R Markdown

```{r}
#loads from .RData and creates matrices
load("~/rnaGinesis/data/exp2.RData")
d <- experiment2$ex
#d <- d[1:200,]
experiment2$sampInfo = seq(1, dim(d)[2])
experiment2$featInfo = seq(1, dim(d)[1])
experiment2$ex <- as.matrix(d)

sig1 = list()
# take first 10 trueW tissue 1, first X genes
sig1$ex = c()
for (i in 1:10) {
  sig1$ex = cbind(sig1$ex, experiment2$trueW[[i]][,1])
}
sig1$featInfo = seq(1, dim(sig1$ex)[1])
sig1$sampInfo = seq(1, dim(sig1$ex)[2])

sig2 = list()
sig2$ex = c()
for (i in 1:10) {
  sig2$ex = cbind(sig2$ex, experiment2$trueW[[i]][,2])
}
sig2$featInfo = seq(1, dim(sig2$ex)[1])
sig2$sampInfo = seq(1, dim(sig2$ex)[2])

```


```{r}
library(SummarizedExperiment)
mixt <- convert_to_SummarizedExperiment(experiment2)
sig3 <- convert_to_SummarizedExperiment(sig1)
sig4 <- convert_to_SummarizedExperiment(sig2)
#assays(mixt)$expression <- exp(assays(mixt)$expression)
#assays(sig3)$expression <- exp(assays(sig3)$expression)
#assays(sig4)$expression <- exp(assays(sig4)$expression)

# calculates rowMean differentials
diff <- abs(rowMeans(assays(sig3)$expression) - rowMeans(assays(sig4)$expression))

# pick top n genes
top_n <- head(order(diff, decreasing = TRUE), n = 100)

```

```{r}


library(DeMixT)
ptm <- proc.time()
res <- DeMixT(data.Y = mixt[top_n],
              data.N1 = sig3[top_n],
              data.N2 = sig4[top_n],
              if.filter = FALSE,
              output.more.info = TRUE, nthread = 1)
proc.time() - ptm
exp2.DEMIXT <- list()
exp2.DEMIXT$resultH <- res$pi
exp2.DEMIXT$resultW <- list()
for (i in 1:50) {
  exp2.DEMIXT$resultW[[i]] <- as.matrix(cbind(res$ExprN1[,i], res$ExprN2[,i], res$ExprT[,i]))
}
# get the indeces of the genes actually returned/used
install.packages("tidyverse")
library(stringr)
genes_used <- as.integer(word(as.character(res$gene.name),2))
exp2.DEMIXT$top_n <- top_n[genes_used]
#save(res, file = "~/rnaGinesis/data/exp2.2000.DeMixT.result.RData")
save(exp2.DEMIXT, file = "~/rnaGinesis/data/exp2_100_DEMIXT.result.RData")
```